name: Manual deploy (push image and apply k8s)

on:
  workflow_dispatch: {}

# Required repository secrets (add these in GitHub Settings -> Secrets and variables -> Actions):
# - DOCKERHUB_USERNAME : your Docker Hub username (e.g. karthikvelouiitj)
# - DOCKERHUB_TOKEN    : a Docker Hub access token (create in Docker Hub account settings)
# - KUBECONFIG         : (optional) base64-encoded kubeconfig to allow automatic deploy to your cluster

jobs:
  publish-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push image to Docker Hub
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/olivetti:latest

    - name: Deploy to Kubernetes (requires KUBECONFIG secret)
      if: ${{ secrets.KUBECONFIG }}
      env:
        KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG }}
        DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        echo "$KUBECONFIG_BASE64" | base64 --decode > kubeconfig
        export KUBECONFIG=$PWD/kubeconfig
        # Option A: update the deployment image directly to the pushed Docker Hub image
        kubectl set image deployment/olivetti-app olivetti=${DOCKER_USER}/olivetti:latest --record
        kubectl rollout status deployment/olivetti-app --timeout=120s

    - name: Done
      run: echo "Publish and deploy workflow finished"
